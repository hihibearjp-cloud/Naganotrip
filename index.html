<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ç­ç´šå°ç®¡å®¶</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#FEF9F2">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3595/3595490.png">

  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

  <style>
    /* ä¿®æ­£ iOS åº•éƒ¨å®‰å…¨å€åŸŸ */
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .pb-safe-area-inset-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-[#FEF9F2]">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    
    // å¾å…¨åŸŸè®Šæ•¸å–å¾—åœ–ç¤º
    const { 
      Calendar, User, Users, Clock, BookOpen, AlertCircle, 
      CheckCircle2, MessageCircle, MicOff, Coffee, FileWarning, 
      Edit3, Trash2, ChevronDown, ChevronUp, Save, Share2,
      Plus, X, Briefcase, Stethoscope, Palmtree, HelpCircle, Star, PackageX,
      ClipboardCopy, Smile, Download, Settings, FileSpreadsheet, List, UserCog,
      Share, MoreVertical, LayoutGrid, Info, PenTool, AlertTriangle, Megaphone, Send,
      Smartphone, Database, Upload, Check
    } = window.lucideReact;

    // --- 1. å…¨å±€æ¨£å¼èˆ‡å­—é«” ---
    const customStyles = `
      @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

      body {
        background-color: #FEF9F2;
        background-image: 
          linear-gradient(#E8E8E8 1px, transparent 1px),
          linear-gradient(90deg, #E8E8E8 1px, transparent 1px);
        background-size: 20px 20px;
        font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
        color: #5D4037;
        font-size: 18px; 
        overscroll-behavior-y: none;
        user-select: none;
      }

      .btn-3d {
        transition: transform 0.05s, box-shadow 0.05s;
        border: 3px solid #5D4037;
        box-shadow: 4px 4px 0px #5D4037;
        border-radius: 16px; 
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
        font-size: 1.2rem; 
      }
      
      .btn-3d:active {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0px #5D4037;
      }

      .bg-mint { background-color: #CDF0EA; }
      .bg-yellow { background-color: #FDFD96; }
      .bg-pink { background-color: #FFC4C4; }
      .bg-blue-soft { background-color: #C4E4FF; }
      .bg-purple-soft { background-color: #E2C4FF; }
      .bg-orange-soft { background-color: #FFD8B1; }
      .bg-red-alert { background-color: #FF8A80; color: white; }
      .bg-line { background-color: #06C755; color: white; }
      .bg-dark { background-color: #4A4A4A; color: white; }

      .text-coffee { color: #5D4037; }
      .border-coffee { border-color: #5D4037; }

      .doodle-card {
        background: white;
        border: 3px solid #5D4037;
        border-radius: 24px;
        box-shadow: 6px 6px 0px rgba(93, 64, 55, 0.2);
      }

      .input-hand {
        border: 3px solid #5D4037;
        border-radius: 12px;
        padding: 12px 16px; 
        background: #FFF;
        font-family: 'ZCOOL KuaiLe', cursive;
        outline: none;
        width: 100%;
        font-size: 1.1rem; 
        user-select: text;
      }
      .input-hand:focus { box-shadow: 3px 3px 0px #5D4037; }
      
      .modal-scroll {
        max-height: 70vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
    `;

    // --- 2. å¸¸æ•¸å®šç¾© ---
    const PERIODS = [
      { id: 'early', label: 'æ—©ä¿®' },
      { id: 'p1', label: 'ç¬¬ä¸€ç¯€' },
      { id: 'p2', label: 'ç¬¬äºŒç¯€' },
      { id: 'p3', label: 'ç¬¬ä¸‰ç¯€' },
      { id: 'p4', label: 'ç¬¬å››ç¯€' },
      { id: 'lunch', label: 'åˆé¤' },
      { id: 'nap', label: 'åˆä¼‘' },
      { id: 'p5', label: 'ç¬¬äº”ç¯€' },
      { id: 'p6', label: 'ç¬¬å…­ç¯€' },
      { id: 'p7', label: 'ç¬¬ä¸ƒç¯€' },
      { id: 'p8', label: 'ç¬¬å…«ç¯€' },
    ];

    const DEFAULT_BEHAVIORS = [
      { id: 'item_missing', label: 'ç‰©å“æœªå¸¶', icon: 'PackageX', color: 'bg-pink' },
      { id: 'late_class', label: 'æ™šé€²æ•™å®¤', icon: 'Clock', color: 'bg-yellow' },
      { id: 'rude', label: 'å°å¸«ä¸ç¦®è²Œ', icon: 'MicOff', color: 'bg-pink' },
      { id: 'noise', label: 'åµé¬§å¹²æ“¾', icon: 'AlertCircle', color: 'bg-pink' },
      { id: 'chat', label: 'èŠå¤©', icon: 'MessageCircle', color: 'bg-yellow' },
      { id: 'note', label: 'å‚³ç´™æ¢', icon: 'FileWarning', color: 'bg-yellow' },
      { id: 'other_book', label: 'çœ‹èª²å¤–æ›¸', icon: 'BookOpen', color: 'bg-yellow' },
      { id: 'sleep', label: 'æ‰“çŒç¡', icon: 'Coffee', color: 'bg-pink' },
      { id: 'no_hw_cls', label: 'ä½œæ¥­æœªäº¤', icon: 'FileWarning', color: 'bg-pink' },
      { id: 'other', label: 'å…¶ä»–', icon: 'PenTool', color: 'bg-blue-soft' },
    ];

    const ATTENDANCE_TYPES = [
      { id: 'late', label: 'é²åˆ°', icon: Clock, color: 'bg-yellow' },
      { id: 'sick', label: 'ç—…å‡', icon: Stethoscope, color: 'bg-mint' },
      { id: 'official', label: 'å…¬å‡', icon: Briefcase, color: 'bg-blue-soft' },
      { id: 'personal', label: 'äº‹å‡', icon: Palmtree, color: 'bg-purple-soft' },
      { id: 'other_leave', label: 'å…¶ä»–', icon: HelpCircle, color: 'bg-gray-200' },
      { id: 'absent', label: 'ç¼ºå¸­', icon: AlertCircle, color: 'bg-pink' },
    ];

    const CONTACT_BOOK_TYPES = [
      { id: 'cb_missing', label: 'è¯çµ¡ç°¿ç¼ºäº¤', icon: X, color: 'bg-pink' },
      { id: 'cb_no_sign', label: 'å®¶é•·æœªç°½å', icon: PenTool, color: 'bg-yellow' }, 
      { id: 'cb_good', label: 'è¯çµ¡ç°¿å„ªè‰¯', icon: Star, color: 'bg-mint' },
    ];

    const DEFAULT_SUBJECTS = [
      { id: 'chinese', label: 'åœ‹æ–‡' },
      { id: 'english', label: 'è‹±èª' },
      { id: 'math', label: 'æ•¸å­¸' },
      { id: 'science', label: 'ç†åŒ–' },
      { id: 'civics', label: 'å…¬æ°‘' },
      { id: 'history', label: 'æ­·å²' },
      { id: 'geo', label: 'åœ°ç†' },
    ];

    const ICON_MAP = {
      PackageX, Clock, MicOff, AlertCircle, MessageCircle, FileWarning, BookOpen, Coffee, HelpCircle, PenTool
    };

    const DB_KEY = 'classLogDB_V10_Final'; 

    // --- 3. ç¨ç«‹å…ƒä»¶ï¼šå­¸ç”Ÿé¸æ“‡å™¨ ---
    const StudentSelectorModal = ({ isOpen, onClose, students, selectedList, title, onToggle }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-[#FEF9F2] w-full max-w-sm rounded-2xl border-4 border-coffee shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div className="bg-yellow p-4 border-b-4 border-coffee flex justify-between items-center">
              <h3 className="text-2xl font-bold text-coffee">é»é¸å­¸ç”Ÿ</h3>
              <button onClick={onClose} className="bg-white p-2 rounded-full border-2 border-coffee"><CheckCircle2 size={32} /></button>
            </div>
            <div className="bg-yellow px-4 pb-2 text-coffee font-bold opacity-80 border-b-2 border-coffee mb-2">æ­£åœ¨ç™»è¨˜ï¼š{title}</div>
            <div className="p-4 overflow-y-auto grid grid-cols-4 gap-3 modal-scroll">
              {students.map(s => (
                <button key={s.id} onClick={() => onToggle(s.id)} className={`p-2 rounded-xl border-2 border-coffee font-bold text-base flex flex-col items-center justify-center transition-all min-h-[70px] ${selectedList.includes(s.id) ? 'bg-coffee text-white transform scale-105 shadow-lg' : 'bg-white text-coffee hover:bg-gray-100'}`}>
                  <span className="text-sm opacity-70 mb-1">#{s.id}</span>
                  <span className="truncate w-full text-center text-lg">{s.name}</span>
                </button>
              ))}
            </div>
            <div className="p-4 bg-white border-t-4 border-coffee text-center"><button onClick={onClose} className="btn-3d w-full bg-mint py-4 text-2xl">å®Œ æˆ</button></div>
          </div>
        </div>
      );
    };

    // --- 4. ä¸»ç¨‹å¼ App ---
    function App() {
      const [activeTab, setActiveTab] = useState('basic'); 
      
      const [currentDate, setCurrentDate] = useState(() => {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        return new Date(now.getTime() - offset).toISOString().split('T')[0];
      });

      const safeLoad = (key, defaultVal) => {
        try {
          const saved = localStorage.getItem(key);
          return saved ? JSON.parse(saved) : defaultVal;
        } catch (e) {
          console.error("Load Error:", e);
          return defaultVal; 
        }
      };

      const [db, setDb] = useState(() => safeLoad(DB_KEY, {}));
      const [saveStatus, setSaveStatus] = useState('idle');

      const [subjects, setSubjects] = useState(() => safeLoad('classLogSubjects', DEFAULT_SUBJECTS));
      const [behaviors, setBehaviors] = useState(() => safeLoad('classLogBehaviors', DEFAULT_BEHAVIORS));
      const [students, setStudents] = useState(() => safeLoad('classLogStudents', Array.from({ length: 30 }, (_, i) => ({ id: i + 1, name: `${i + 1}è™Ÿ` }))));
      const [teacherNote, setTeacherNote] = useState(() => safeLoad('classLogTeacherNote', ''));

      const todayData = useMemo(() => {
        const data = db[currentDate] || {};
        return {
          week: data.week || '',
          dutyOfficer: data.dutyOfficer || '',
          dutyStudent: data.dutyStudent || '',
          attendanceData: data.attendanceData || {},
          missingData: data.missingData || {},
          classLogData: data.classLogData || {},
          periodNotes: data.periodNotes || {},
          incidentLog: data.incidentLog || ''
        };
      }, [db, currentDate]);

      const updateToday = (field, value) => {
        setSaveStatus('saving');
        setDb(prevDb => {
          const newDb = {
            ...prevDb,
            [currentDate]: {
              ...prevDb[currentDate] || {},
              ...prevDb[currentDate],
              [field]: value
            }
          };
          try {
            localStorage.setItem(DB_KEY, JSON.stringify(newDb));
            setTimeout(() => setSaveStatus('saved'), 500);
          } catch (e) {
            alert("âš ï¸ è­¦å‘Šï¼šå„²å­˜ç©ºé–“ä¸è¶³ï¼");
          }
          return newDb;
        });
      };

      useEffect(() => localStorage.setItem('classLogSubjects', JSON.stringify(subjects)), [subjects]);
      useEffect(() => localStorage.setItem('classLogBehaviors', JSON.stringify(behaviors)), [behaviors]);
      useEffect(() => localStorage.setItem('classLogStudents', JSON.stringify(students)), [students]);
      useEffect(() => localStorage.setItem('classLogTeacherNote', teacherNote), [teacherNote]);

      const [newSubjectName, setNewSubjectName] = useState('');
      const [isAddingSubject, setIsAddingSubject] = useState(false);
      const [newBehaviorName, setNewBehaviorName] = useState('');
      const [isEditingBehaviors, setIsEditingBehaviors] = useState(false);
      const [isSelectorOpen, setIsSelectorOpen] = useState(false);
      const [selectorConfig, setSelectorConfig] = useState({ type: '', category: '', period: '' });
      const [selectedStudentReport, setSelectedStudentReport] = useState(1);
      const [bulkNamesInput, setBulkNamesInput] = useState(''); 
      const [currentSubjectId, setCurrentSubjectId] = useState('');
      const [currentLogPeriod, setCurrentLogPeriod] = useState('p1');

      useEffect(() => {
        if (subjects.length > 0 && !currentSubjectId) setCurrentSubjectId(subjects[0].id);
        else if (currentSubjectId && !subjects.find(s => s.id === currentSubjectId)) setCurrentSubjectId(subjects[0]?.id || '');
      }, [subjects, currentSubjectId]);

      const toggleStudent = (studentId) => {
        const { type, category, period } = selectorConfig;
        if (type === 'attendance') {
          const currentList = todayData.attendanceData[category] || [];
          const newList = currentList.includes(studentId) ? currentList.filter(id => id !== studentId) : [...currentList, studentId];
          updateToday('attendanceData', { ...todayData.attendanceData, [category]: newList });
        } 
        else if (type === 'missing') {
          const currentList = todayData.missingData[category] || [];
          const newList = currentList.includes(studentId) ? currentList.filter(id => id !== studentId) : [...currentList, studentId];
          updateToday('missingData', { ...todayData.missingData, [category]: newList });
        } 
        else if (type === 'log') {
          const periodData = todayData.classLogData[period] || {};
          const currentList = periodData[category] || [];
          const newList = currentList.includes(studentId) ? currentList.filter(id => id !== studentId) : [...currentList, studentId];
          updateToday('classLogData', { ...todayData.classLogData, [period]: { ...periodData, [category]: newList } });
        }
      };

      const getSelectedList = () => {
        const { type, category, period } = selectorConfig;
        if (type === 'attendance') return todayData.attendanceData[category] || [];
        if (type === 'missing') return todayData.missingData[category] || [];
        if (type === 'log') return todayData.classLogData[period]?.[category] || [];
        return [];
      };

      const updatePeriodNote = (val) => {
        updateToday('periodNotes', { ...todayData.periodNotes, [currentLogPeriod]: val });
      };

      const handleBulkImportNames = () => {
        if (!bulkNamesInput.trim()) return;
        const names = bulkNamesInput.split(/\n/).map(n => n.trim()).filter(n => n);
        if (confirm(`å³å°‡åŒ¯å…¥ ${names.length} ä½å­¸ç”Ÿï¼Œç¢ºå®šå—ï¼Ÿ`)) {
          setStudents(names.map((name, index) => ({ id: index + 1, name: name })));
          setBulkNamesInput('');
          alert('åŒ¯å…¥æˆåŠŸï¼');
        }
      };
      const handleUpdateStudentName = (id, newName) => setStudents(students.map(s => s.id === id ? { ...s, name: newName } : s));
      const handleAddSubject = () => { if (newSubjectName.trim()) { const newId = `sub_${Date.now()}`; setSubjects([...subjects, { id: newId, label: newSubjectName.trim() }]); setNewSubjectName(''); setIsAddingSubject(false); setCurrentSubjectId(newId); } };
      const handleDeleteSubject = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç§‘ç›®ï¼Ÿ')) setSubjects(subjects.filter(s => s.id !== id)); };
      const handleAddBehavior = () => { if (newBehaviorName.trim()) { const colors = ['bg-pink', 'bg-yellow', 'bg-mint', 'bg-blue-soft']; setBehaviors([...behaviors, { id: `beh_${Date.now()}`, label: newBehaviorName.trim(), icon: 'AlertCircle', color: colors[Math.floor(Math.random() * colors.length)] }]); setNewBehaviorName(''); } };
      const handleDeleteBehavior = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ')) setBehaviors(behaviors.filter(b => b.id !== id)); };
      
      const handleBehaviorClick = (behaviorId) => {
        if (isEditingBehaviors) return;
        if (behaviorId === 'other') {
          const note = prompt(`è«‹è¼¸å…¥ ${PERIODS.find(p=>p.id===currentLogPeriod)?.label} çš„å…¶ä»–èªªæ˜ï¼š`, todayData.periodNotes[currentLogPeriod] || '');
          if (note !== null) updatePeriodNote(note);
          openSelector('log', behaviorId, currentLogPeriod);
        } else {
          openSelector('log', behaviorId, currentLogPeriod);
        }
      };
      const openSelector = (type, category, period = null) => { setSelectorConfig({ type, category, period }); setIsSelectorOpen(true); };

      const handleBackupData = () => {
        const backupData = { version: '10.0', timestamp: new Date().toISOString(), allData: db, settings: { subjects, behaviors, students, teacherNote } };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
        const link = document.createElement('a'); link.href = dataStr; link.download = `ç­ç´šå°ç®¡å®¶_å‚™ä»½_${currentDate}.json`; link.click();
      };
      const handleRestoreData = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            if (confirm(`ç¢ºå®šè¦é‚„åŸè³‡æ–™å—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡è¢«è¦†è“‹ï¼`)) {
              if (backup.allData) { setDb(backup.allData); localStorage.setItem(DB_KEY, JSON.stringify(backup.allData)); }
              if (backup.settings) {
                 if (backup.settings.subjects) setSubjects(backup.settings.subjects);
                 if (backup.settings.behaviors) setBehaviors(backup.settings.behaviors);
                 if (backup.settings.students) setStudents(backup.settings.students);
                 if (backup.settings.teacherNote) setTeacherNote(backup.settings.teacherNote);
              }
              alert('âœ… é‚„åŸæˆåŠŸï¼');
            }
          } catch { alert('âŒ æª”æ¡ˆéŒ¯èª¤'); }
        };
        reader.readAsText(file);
        event.target.value = '';
      };
      const downloadCSV = (content, filename) => {
        const bom = '\uFEFF'; const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click();
      };

      const getWeeklyStats = (studentId) => {
        const dates = []; const today = new Date(currentDate);
        for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); }
        let stats = { attendance: {}, missing: {}, behavior: {} };
        let detailedBehaviors = [], detailedAttendance = [], detailedMissing = [];
        
        dates.forEach(date => {
          const data = db[date]; if (!data) return;
          const dateStr = date.slice(5).replace('-','/');
          
          if (data.attendanceData) Object.keys(data.attendanceData).forEach(k => { if (data.attendanceData[k]?.includes(studentId)) { stats.attendance[k] = (stats.attendance[k] || 0) + 1; const type = ATTENDANCE_TYPES.find(t => t.id === k); detailedAttendance.push(`${dateStr} ${type ? type.label : k}`); } });
          if (data.missingData) Object.keys(data.missingData).forEach(k => { if (data.missingData[k]?.includes(studentId)) { let label = k; const sub = subjects.find(s => s.id === k); const cb = CONTACT_BOOK_TYPES.find(c => c.id === k); if (sub) label = sub.label + 'ä½œæ¥­ç¼ºäº¤'; if (cb) label = cb.label; stats.missing[label] = (stats.missing[label] || 0) + 1; detailedMissing.push(`${dateStr} ${label}`); } });
          if (data.classLogData) Object.keys(data.classLogData).forEach(periodId => { const pLog = data.classLogData[periodId]; const pNote = data.periodNotes?.[periodId]; if (pLog) { Object.keys(pLog).forEach(bId => { if (pLog[bId]?.includes(studentId)) { const b = behaviors.find(be => be.id === bId); let label = b ? b.label : 'å…¶ä»–'; let displayLabel = label; if (bId === 'other') { if (pNote) displayLabel = pNote; else displayLabel = "å…¶ä»–é•è¦"; } else { if (pNote) displayLabel = `${label} (${pNote})`; } const periodLabel = PERIODS.find(p => p.id === periodId)?.label || periodId; stats.behavior[label] = (stats.behavior[label] || 0) + 1; detailedBehaviors.push(`${dateStr} ${periodLabel}ï¼š${displayLabel}`); } }); } });
        });
        return { dates, stats, detailedBehaviors: detailedBehaviors.reverse(), detailedAttendance: detailedAttendance.reverse(), detailedMissing: detailedMissing.reverse() };
      };

      const exportWholeClassWeekly = () => { const dates = []; const today = new Date(currentDate); for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); } const dateRange = `${dates[dates.length-1]} ~ ${dates[0]}`; let csv = `å…¨ç­é€±å ±è¡¨\nçµ±è¨ˆç¯„åœ,${dateRange}\n\n`; csv += `åº§è™Ÿ,å§“å,ç¼ºå‹¤ç¸½æ•¸,ç¼ºäº¤ç¸½æ•¸,é•è¦ç¸½æ•¸,ç¼ºå‹¤æ˜ç´°,ç¼ºäº¤æ˜ç´°,é•è¦æ˜ç´°\n`; students.forEach(student => { const { stats, detailedBehaviors, detailedAttendance, detailedMissing } = getWeeklyStats(student.id); const totalAtt = Object.values(stats.attendance).reduce((a,b) => a+b, 0); const totalMiss = Object.values(stats.missing).reduce((a,b) => a+b, 0); const totalBeh = Object.values(stats.behavior).reduce((a,b) => a+b, 0); csv += `${student.id},${student.name},${totalAtt},${totalMiss},${totalBeh},"${detailedAttendance.join('ï¼›')}","${detailedMissing.join('ï¼›')}","${detailedBehaviors.join('ï¼›')}"\n`; }); downloadCSV(csv, `å…¨ç­é€±å ±è¡¨_${currentDate}.csv`); };
      const exportStudentWeekly = () => { const s = students.find(s => s.id === selectedStudentReport); if(!s) return alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿ'); const { dates, stats } = getWeeklyStats(selectedStudentReport); let csv = `å­¸ç”Ÿå€‹åˆ¥é€±å ±è¡¨\nåº§è™Ÿ,${s.id}\nå§“å,${s.name}\nçµ±è¨ˆç¯„åœ,${dates[dates.length-1]} ~ ${dates[0]}\n\n`; csv += `é¡åˆ¥,é …ç›®,æ¬¡æ•¸\n`; Object.entries(stats.attendance).forEach(([k, v]) => csv += `ç¼ºå‹¤,${ATTENDANCE_TYPES.find(t=>t.id===k)?.label||k},${v}\n`); Object.entries(stats.missing).forEach(([k, v]) => csv += `ç¼ºäº¤,${k},${v}\n`); Object.entries(stats.behavior).forEach(([k, v]) => csv += `é•è¦,${k},${v}\n`); downloadCSV(csv, `${s.name}_é€±å ±è¡¨.csv`); };
      const exportDailyLog = () => { let csv = `ç­ç´šæ—¥èªŒ,æ—¥æœŸï¼š${currentDate},é€±æ¬¡ï¼š${todayData.week},å€¼æ—¥ï¼š${todayData.dutyOfficer}/${todayData.dutyStudent}\n\n`; csv += `ã€åˆ°æ ¡ã€‘\né¡åˆ¥,å­¸ç”Ÿ\n`; ATTENDANCE_TYPES.forEach(t => { const list = todayData.attendanceData[t.id]?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; if(list) csv += `${t.label},"${list}"\n`; }); csv += `\nã€ä½œæ¥­ã€‘\né …ç›®,ç¼ºäº¤\n`; const getMissingNames = (list) => list?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; CONTACT_BOOK_TYPES.forEach(t => { const str = getMissingNames(todayData.missingData[t.id]); if(str) csv += `${t.label},"${str}"\n`; }); subjects.forEach(s => { const str = getMissingNames(todayData.missingData[s.id]); if(str) csv += `${s.label}ç¼ºäº¤,"${str}"\n`; }); csv += `\nã€èª²å ‚ã€‘\næ™‚æ®µ,è¡Œç‚º,å­¸ç”Ÿ,å‚™è¨»\n`; PERIODS.forEach(p => { const logs = todayData.classLogData[p.id]; const note = todayData.periodNotes[p.id] || ''; if (logs) { behaviors.forEach(b => { const rawList = logs[b.id]; if (rawList && rawList.length > 0) { const names = rawList.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€'); csv += `${p.label},${b.label},"${names}","${note}"\n`; } }); } if ((!logs || Object.keys(logs).every(k => logs[k].length === 0)) && note) { csv += `${p.label},å‚™è¨»,,"${note}"\n`; } }); csv += `\nã€å¶ç™¼ã€‘\n"${todayData.incidentLog.replace(/"/g, '""')}"\n`; downloadCSV(csv, `ç­ç´šæ—¥èªŒ_${currentDate}.csv`); };
      const generateParentMessage = (studentId) => { const s = students.find(stud => stud.id === studentId); if (!s) return "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ..."; const { dates, stats, detailedBehaviors, detailedAttendance, detailedMissing } = getWeeklyStats(studentId); const dateRange = `${dates[dates.length-1].slice(5).replace('-','/')} ~ ${dates[0].slice(5).replace('-','/')}`; let msg = ""; if (teacherNote.trim()) { msg += `ğŸ“¢ â­â­â­ é‡è¦é€šçŸ¥ â­â­â­\n${teacherNote}\n\n------------------------------\n\n`; } msg += `ã€ç­ç´šé€±å ±ã€‘è¦ªæ„›çš„å®¶é•·æ‚¨å¥½ï¼Œé€™æ˜¯ ${s.name} æœ¬é€± (${dateRange}) çš„åœ¨æ ¡è¡¨ç¾æ‘˜è¦ï¼š\n\n`; if (detailedAttendance.length > 0) { msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ï¼š\n`; detailedAttendance.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ï¼šå…¨å‹¤ ğŸ‘\n`; } if (detailedMissing.length > 0) { msg += `ğŸ“š ä½œæ¥­èˆ‡ç‰©å“ï¼š\n`; detailedMissing.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `ğŸ“š ä½œæ¥­ç¹³äº¤ï¼šç‹€æ³è‰¯å¥½ ğŸ‘\n`; } if (detailedBehaviors.length > 0) { msg += `âš ï¸ èª²å ‚å¸¸è¦æé†’ï¼š\n`; detailedBehaviors.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `âœ¨ èª²å ‚è¡¨ç¾ï¼šéµå®ˆå¸¸è¦ï¼Œè¡¨ç¾ç©©å®šã€‚\n`; } msg += `\nå†è«‹æ‚¨å”åŠ©é—œå¿ƒå­©å­çš„å­¸ç¿’ç‹€æ³ï¼Œè¬è¬æ‚¨çš„é…åˆï¼`; return msg; };
      const handleLineShare = (text) => { const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`; window.open(lineUrl, '_blank'); };
      const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½è¨Šæ¯ï¼')); };

      // --- Render Functions ---
      const renderBasicInfo = () => (
        <div className="space-y-6 pb-24">
          <div className="doodle-card p-5 space-y-4 bg-white"><div className="flex gap-3"><div className="flex-1"><label className="text-base font-bold opacity-70">æ—¥æœŸ</label><input type="date" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input-hand text-lg" /></div><div className="w-1/3"><label className="text-base font-bold opacity-70">é€±æ¬¡</label><input type="text" value={todayData.week} onChange={e => updateToday('week', e.target.value)} className="input-hand text-center text-lg" /></div></div><div className="flex gap-3"><div className="flex-1"><label className="text-base font-bold opacity-70">å€¼æ—¥å¹¹éƒ¨</label><input type="text" value={todayData.dutyOfficer} onChange={e => updateToday('dutyOfficer', e.target.value)} className="input-hand text-lg" /></div><div className="flex-1"><label className="text-base font-bold opacity-70">å€¼æ—¥ç”Ÿ</label><input type="text" value={todayData.dutyStudent} onChange={e => updateToday('dutyStudent', e.target.value)} className="input-hand text-lg" /></div></div></div>
          <div className="doodle-card p-5 bg-white relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-4 bg-mint border-b-2 border-coffee"></div><h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><Clock size={28} /> åˆ°æ ¡ç‹€æ³</h3><div className="grid grid-cols-2 gap-4">{ATTENDANCE_TYPES.map(type => { const count = todayData.attendanceData[type.id]?.length || 0; return <button key={type.id} onClick={() => openSelector('attendance', type.id)} className={`btn-3d p-3 flex items-center justify-between px-4 ${type.color} text-lg h-14`}><div className="flex items-center gap-2"><type.icon size={20} /><span>{type.label}</span></div>{count > 0 && <span className="bg-coffee text-white text-sm px-3 py-1 rounded-full">{count}</span>}</button> })}</div></div>
          <div className="doodle-card p-5 bg-white relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-4 bg-yellow border-b-2 border-coffee"></div>
            <h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><FileWarning size={28} /> ä½œæ¥­èˆ‡è¯çµ¡ç°¿</h3>
            <div className="grid grid-cols-1 gap-3 mb-4">{CONTACT_BOOK_TYPES.map(item => <button key={item.id} onClick={() => openSelector('missing', item.id)} className={`btn-3d w-full py-3 flex justify-between px-5 text-lg ${item.color}`}><div className="flex items-center gap-3"><item.icon size={22}/><span>{item.label}</span></div>{todayData.missingData[item.id]?.length > 0 && <span className="bg-coffee text-white text-sm px-3 py-1 rounded-full">{todayData.missingData[item.id].length}</span>}</button>)}</div>
            <div className="border-t-2 border-coffee pt-4 space-y-4">
               <div className="flex justify-between items-center"><h4 className="font-bold text-coffee opacity-80 text-lg">å„ç§‘ä½œæ¥­ç¼ºäº¤</h4><button onClick={() => setIsAddingSubject(!isAddingSubject)} className="text-sm bg-mint px-3 py-1 rounded-full border-2 border-coffee hover:bg-green-200"><Plus size={16} /></button></div>
               {isAddingSubject && <div className="flex gap-2"><input autoFocus type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand text-lg py-2" /><button onClick={handleAddSubject} className="btn-3d px-4 bg-coffee text-white text-lg">OK</button></div>}
               {subjects.length > 0 ? (
                 <div className="space-y-3">
                   <div className="flex gap-2">
                     <select value={currentSubjectId} onChange={(e) => setCurrentSubjectId(e.target.value)} className="input-hand text-lg flex-1 bg-gray-50 font-bold border-2 border-coffee">{subjects.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select>
                     <button onClick={(e) => handleDeleteSubject(currentSubjectId, e)} className="btn-3d bg-pink text-white px-3"><Trash2 size={24}/></button>
                   </div>
                   <button onClick={() => openSelector('missing', currentSubjectId)} className="btn-3d w-full bg-white py-4 text-lg flex justify-between px-5 border-2 border-coffee shadow-sm group active:bg-yellow">
                     <span className="font-bold flex items-center gap-2"><Edit3 size={20}/> ç™»è¨˜ {subjects.find(s=>s.id===currentSubjectId)?.label} ç¼ºäº¤</span>
                     {todayData.missingData[currentSubjectId]?.length > 0 ? (
                        <div className="text-right"><span className="bg-pink text-white px-3 py-1 rounded-full text-sm font-bold block w-fit ml-auto mb-1">{todayData.missingData[currentSubjectId].length} äºº</span><span className="text-xs text-pink-600 font-bold block max-w-[150px] truncate">{todayData.missingData[currentSubjectId].sort((a,b)=>a-b).join('ã€')}è™Ÿ</span></div>
                     ) : <span className="text-gray-400 text-sm">é»æ“Šç™»è¨˜</span>}
                   </button>
                 </div>
               ) : <div className="text-center text-gray-400 py-2">è«‹å…ˆæ–°å¢ç§‘ç›®...</div>}
               <div className="flex flex-col gap-2 mt-2">{subjects.map(s => { const list = todayData.missingData[s.id]; if (!list || list.length === 0) return null; const sortedList = [...list].sort((a,b) => a-b).join('ã€'); return ( <button key={s.id} onClick={() => { setCurrentSubjectId(s.id); openSelector('missing', s.id); }} className="bg-white border-2 border-coffee px-3 py-2 rounded-xl text-sm font-bold flex items-center justify-between shadow-sm hover:bg-gray-50 w-full text-left"><span className="flex items-center gap-2 text-lg text-coffee">{s.label}</span><div className="flex items-center gap-2 overflow-hidden"><span className="text-coffee opacity-80 truncate text-sm">ç¼ºäº¤ï¼š{sortedList}è™Ÿ</span><span className="bg-pink text-white px-2 py-1 rounded-full text-xs shrink-0">{list.length}äºº</span></div></button> ) })}</div>
            </div>
          </div>
        </div>
      );

      const renderLog = () => (
        <div className="space-y-5 pb-24">
          <div className="doodle-card p-4 bg-white flex flex-col gap-3">
            <div className="flex items-center gap-2">
              <label className="font-bold text-coffee text-xl shrink-0">é¸æ“‡æ™‚æ®µï¼š</label>
              <select value={currentLogPeriod} onChange={(e) => setCurrentLogPeriod(e.target.value)} className="input-hand text-2xl font-bold bg-yellow border-2 border-coffee h-14 flex-1">
                {PERIODS.map(p => <option key={p.id} value={p.id}>{p.label}</option>)}
              </select>
            </div>
            <div className="relative">
              <input type="text" value={todayData.periodNotes[currentLogPeriod] || ''} onChange={(e) => updatePeriodNote(e.target.value)} placeholder={`åœ¨æ­¤è¼¸å…¥${PERIODS.find(p=>p.id===currentLogPeriod)?.label}çš„å‚™è¨»...`} className="input-hand text-lg bg-gray-50 pr-10" />
              <PenTool size={20} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
            </div>
          </div>
          <div className="flex justify-between items-center px-1">
            <h4 className="font-bold text-coffee opacity-80 text-xl">é•è¦é …ç›®</h4>
            <button onClick={() => setIsEditingBehaviors(!isEditingBehaviors)} className={`px-3 py-1 rounded-full border-2 border-coffee text-sm font-bold flex items-center gap-1 ${isEditingBehaviors ? 'bg-pink text-white' : 'bg-gray-100'}`}><Settings size={16} /> {isEditingBehaviors ? 'å®Œæˆ' : 'ç·¨è¼¯'}</button>
          </div>
          {isEditingBehaviors && <div className="doodle-card p-4 bg-yellow flex gap-3"><input type="text" value={newBehaviorName} onChange={e => setNewBehaviorName(e.target.value)} placeholder="æ–°é•è¦é …ç›®..." className="input-hand text-lg" /><button onClick={handleAddBehavior} className="btn-3d bg-coffee text-white px-4"><Plus size={24}/></button></div>}
          <div className="grid grid-cols-3 gap-3">{behaviors.map(behavior => { 
            const count = todayData.classLogData[currentLogPeriod]?.[behavior.id]?.length || 0; 
            const Icon = ICON_MAP[behavior.icon] || AlertCircle; 
            return ( 
              <button key={behavior.id} onClick={() => handleBehaviorClick(behavior.id)} className={`btn-3d p-2 flex flex-col items-center gap-1 ${behavior.color} min-h-[90px] relative`}>
                {isEditingBehaviors && <span onClick={(e) => handleDeleteBehavior(behavior.id, e)} className="absolute top-1 right-1 bg-white rounded-full p-1 border border-coffee text-red-500 z-20"><X size={14} strokeWidth={3} /></span>}
                <Icon size={32} />
                <span className="text-xl text-center leading-tight">{behavior.label}</span>
                {!isEditingBehaviors && count > 0 && <span className="absolute -top-2 -right-2 bg-coffee text-white text-xs w-7 h-7 flex items-center justify-center rounded-full border-2 border-white shadow-md font-bold animate-bounce">{count}</span>}
              </button> 
            );
          })}</div>

          {/* é¡¯ç¤ºè©²æ™‚æ®µå·²ç™»è¨˜çš„è©³ç´°æ¸…å–® */}
          <div className="mt-6 space-y-2">
             {behaviors.map(b => {
                const list = todayData.classLogData[currentLogPeriod]?.[b.id];
                if(!list || list.length === 0) return null;
                return (
                  <div key={b.id} className="bg-white border-2 border-coffee rounded-xl p-3 shadow-sm">
                     <div className="flex items-center gap-2 mb-2 border-b-2 border-gray-100 pb-2">
                        <div className={`w-3 h-3 rounded-full ${b.color}`}></div>
                        <span className="font-bold text-coffee">{b.label}</span>
                     </div>
                     <div className="flex flex-wrap gap-2">
                        {list.map(studentId => {
                           const s = students.find(stud => stud.id === studentId);
                           return (
                             <button key={studentId} onClick={() => toggleStudent(studentId)} className="bg-gray-100 hover:bg-pink-100 text-coffee px-3 py-1 rounded-lg text-sm font-bold flex items-center gap-1 border border-gray-300">
                                {s ? `${s.id}.${s.name}` : `${studentId}è™Ÿ`} <X size={14}/>
                             </button>
                           )
                        })}
                     </div>
                  </div>
                )
             })}
          </div>
        </div>
      );

      const renderSettings = () => (
        <div className="space-y-6 pb-24">
           {/* 1. è€å¸«å‚™å¿˜éŒ„ */}
           <div className="doodle-card p-5 bg-white">
              <h3 className="text-2xl font-bold mb-3 flex items-center gap-2 text-coffee"><Megaphone size={24}/> è€å¸«å‚™å¿˜ / å…¬å‘Š</h3>
              <textarea 
                value={teacherNote} 
                onChange={(e) => setTeacherNote(e.target.value)} 
                className="input-hand w-full h-32 text-lg resize-none" 
                placeholder="è¼¸å…¥è¦é¡¯ç¤ºåœ¨å®¶é•·é€šçŸ¥ä¸­çš„é‡è¦äº‹é …..."
              />
           </div>

           {/* 2. å ±è¡¨è¼¸å‡º */}
           <div className="doodle-card p-5 bg-yellow">
              <h3 className="text-2xl font-bold mb-4 flex items-center gap-2 text-coffee"><FileSpreadsheet size={24}/> å ±è¡¨è¼¸å‡º</h3>
              <div className="grid grid-cols-1 gap-3">
                 <button onClick={exportDailyLog} className="btn-3d bg-white py-3 text-lg"><Download size={20} className="mr-2"/> ä¸‹è¼‰ä»Šæ—¥ç­ç´šæ—¥èªŒ (CSV)</button>
                 <button onClick={exportWholeClassWeekly} className="btn-3d bg-mint py-3 text-lg"><Users size={20} className="mr-2"/> ä¸‹è¼‰å…¨ç­é€±å ±è¡¨ (CSV)</button>
                 
                 <div className="bg-white/50 p-3 rounded-xl border-2 border-coffee mt-2">
                    <label className="text-sm font-bold opacity-70 mb-2 block">å€‹åˆ¥å­¸ç”Ÿé€±å ± / å®¶é•·é€šçŸ¥</label>
                    <div className="flex gap-2">
                       <select value={selectedStudentReport} onChange={e => setSelectedStudentReport(Number(e.target.value))} className="input-hand flex-1 text-lg py-2">
                          {students.map(s => <option key={s.id} value={s.id}>{s.id}. {s.name}</option>)}
                       </select>
                    </div>
                    <div className="grid grid-cols-2 gap-2 mt-2">
                       <button onClick={exportStudentWeekly} className="btn-3d bg-white py-2 text-base"><Download size={18} className="mr-2"/> ä¸‹è¼‰é€±å ±</button>
                       <button onClick={() => {
                          const msg = generateParentMessage(selectedStudentReport);
                          if(confirm('å³å°‡é–‹å•Ÿ LINE åˆ†äº«é é¢ï¼Œç¢ºå®šå—ï¼Ÿ')) handleLineShare(msg);
                       }} className="btn-3d bg-line py-2 text-base"><Share size={18} className="mr-2"/> LINE é€šçŸ¥</button>
                       <button onClick={() => {
                          const msg = generateParentMessage(selectedStudentReport);
                          copyToClipboard(msg);
                       }} className="btn-3d bg-blue-soft py-2 text-base col-span-2"><ClipboardCopy size={18} className="mr-2"/> è¤‡è£½é€šçŸ¥æ–‡å­—</button>
                    </div>
                 </div>
              </div>
           </div>

           {/* 3. è³‡æ–™ç®¡ç† (å‚™ä»½/é‚„åŸ) */}
           <div className="doodle-card p-5 bg-pink text-coffee">
              <h3 className="text-2xl font-bold mb-4 flex items-center gap-2"><Database size={24}/> è³‡æ–™å®‰å…¨</h3>
              <div className="grid grid-cols-2 gap-3">
                 <button onClick={handleBackupData} className="btn-3d bg-white py-3 text-lg"><Save size={20} className="mr-2"/> å‚™ä»½è³‡æ–™</button>
                 <label className="btn-3d bg-white py-3 text-lg cursor-pointer">
                    <Upload size={20} className="mr-2"/> é‚„åŸè³‡æ–™
                    <input type="file" accept=".json" onChange={handleRestoreData} className="hidden" />
                 </label>
              </div>
              <p className="text-xs mt-2 opacity-70 text-center font-bold">å»ºè­°æ¯é€±äº”ä¸‹è¼‰å‚™ä»½æª”ä¿å­˜</p>
           </div>

           {/* 4. å­¸ç”Ÿåå–®ç®¡ç† */}
           <div className="doodle-card p-5 bg-white">
              <h3 className="text-2xl font-bold mb-4 flex items-center gap-2"><UserCog size={24}/> å­¸ç”Ÿåå–®ç®¡ç†</h3>
              <textarea 
                 value={bulkNamesInput} 
                 onChange={e => setBulkNamesInput(e.target.value)} 
                 className="input-hand h-24 text-sm mb-2" 
                 placeholder="åœ¨æ­¤è²¼ä¸Šå­¸ç”Ÿåå–® (ä¸€è¡Œä¸€å€‹åå­—)...&#10;ç‹å°æ˜&#10;æå¤§è¯&#10;å¼µå°ç¾"
              />
              <button onClick={handleBulkImportNames} className="btn-3d bg-coffee text-white w-full py-3 mb-4">æ‰¹æ¬¡åŒ¯å…¥ / é‡è¨­åå–®</button>
              
              <div className="max-h-60 overflow-y-auto border-2 border-coffee rounded-xl p-2 bg-gray-50 grid grid-cols-2 gap-2">
                 {students.map(s => (
                    <div key={s.id} className="flex items-center gap-1 bg-white p-1 rounded border border-gray-200">
                       <span className="w-6 text-center font-bold text-gray-400 text-xs">{s.id}</span>
                       <input 
                          type="text" 
                          value={s.name} 
                          onChange={(e) => handleUpdateStudentName(s.id, e.target.value)}
                          className="flex-1 bg-transparent border-none text-sm font-bold focus:outline-none text-coffee"
                       />
                    </div>
                 ))}
              </div>
           </div>

           <div className="text-center opacity-40 text-sm font-bold pb-4">
              ç­ç´šå°ç®¡å®¶ V10.0 (Local Storage Edition)
           </div>
        </div>
      );

      return (
        <>
          <style>{customStyles}</style>
          <div className="min-h-screen pb-safe-area-inset-bottom">
            
            {/* é ‚éƒ¨æ¨™é¡Œåˆ— */}
            <div className="sticky top-0 z-40 bg-[#FEF9F2]/95 backdrop-blur-sm px-4 py-3 border-b-4 border-coffee shadow-sm flex justify-between items-center">
               <div>
                  <h1 className="text-3xl text-coffee flex items-center gap-2" style={{ fontFamily: 'ZCOOL KuaiLe' }}>
                    <span className="bg-coffee text-white px-2 rounded-lg transform -rotate-3 text-2xl">ç­</span>
                    <span className="transform rotate-2">ç´šæ—¥èªŒ</span>
                  </h1>
                  <p className="text-xs font-bold text-coffee opacity-60 ml-1">{currentDate} (é€±{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(currentDate).getDay()]})</p>
               </div>
               
               <div className="flex items-center gap-2">
                  {saveStatus === 'saving' && <span className="text-xs bg-yellow px-2 py-1 rounded-full border border-coffee font-bold animate-pulse">å„²å­˜ä¸­...</span>}
                  {saveStatus === 'saved' && <span className="text-xs bg-mint px-2 py-1 rounded-full border border-coffee font-bold text-coffee">å·²å„²å­˜</span>}
               </div>
            </div>

            {/* ä¸»è¦å…§å®¹å€ */}
            <div className="p-4 max-w-lg mx-auto w-full">
               {activeTab === 'basic' && renderBasicInfo()}
               {activeTab === 'log' && renderLog()}
               {activeTab === 'settings' && renderSettings()}
            </div>

            {/* åº•éƒ¨å°èˆªåˆ— */}
            <div className="fixed bottom-0 left-0 w-full bg-white border-t-4 border-coffee pb-safe z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
               <div className="max-w-lg mx-auto grid grid-cols-3 gap-8 px-6 py-2 h-20 items-end">
                  <button onClick={() => setActiveTab('basic')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'basic' ? 'transform -translate-y-3 scale-110' : 'opacity-60 hover:opacity-100'}`}>
                     <div className={`p-3 rounded-2xl border-2 border-coffee shadow-[4px_4px_0px_#5D4037] ${activeTab === 'basic' ? 'bg-mint' : 'bg-white'}`}>
                        <ClipboardCopy size={24} strokeWidth={2.5} className="text-coffee"/>
                     </div>
                     <span className="text-xs font-bold text-coffee">åŸºæœ¬</span>
                  </button>

                  <button onClick={() => setActiveTab('log')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'log' ? 'transform -translate-y-3 scale-110' : 'opacity-60 hover:opacity-100'}`}>
                     <div className={`p-3 rounded-2xl border-2 border-coffee shadow-[4px_4px_0px_#5D4037] ${activeTab === 'log' ? 'bg-yellow' : 'bg-white'}`}>
                        <List size={24} strokeWidth={2.5} className="text-coffee"/>
                     </div>
                     <span className="text-xs font-bold text-coffee">æ—¥èªŒ</span>
                  </button>

                  <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'settings' ? 'transform -translate-y-3 scale-110' : 'opacity-60 hover:opacity-100'}`}>
                     <div className={`p-3 rounded-2xl border-2 border-coffee shadow-[4px_4px_0px_#5D4037] ${activeTab === 'settings' ? 'bg-pink' : 'bg-white'}`}>
                        <Settings size={24} strokeWidth={2.5} className="text-coffee"/>
                     </div>
                     <span className="text-xs font-bold text-coffee">è¨­å®š</span>
                  </button>
               </div>
            </div>

            {/* å­¸ç”Ÿé¸æ“‡ Modal */}
            <StudentSelectorModal 
               isOpen={isSelectorOpen} 
               onClose={() => setIsSelectorOpen(false)}
               students={students}
               selectedList={getSelectedList()}
               title={
                 selectorConfig.type === 'attendance' ? ATTENDANCE_TYPES.find(t=>t.id===selectorConfig.category)?.label :
                 selectorConfig.type === 'missing' ? (CONTACT_BOOK_TYPES.find(t=>t.id===selectorConfig.category)?.label || subjects.find(s=>s.id===selectorConfig.category)?.label) :
                 (behaviors.find(b=>b.id===selectorConfig.category)?.label || 'é•è¦é …ç›®')
               }
               onToggle={toggleStudent}
            />

          </div>
        </>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
